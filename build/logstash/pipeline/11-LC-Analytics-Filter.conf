filter{
	if [type] == "report" {
		mutate {
			add_field => { 
				"MachineName" => "%{[@metadata][rabbitmq_headers][MachineName]}"				
				"ReportType" => "%{[@metadata][rabbitmq_headers][ReportType]}"
			}	
			remove_field => ["@version"]							
		}
		if [Parameters]{
			json{
				skip_on_invalid_json => true
				source => "Parameters"
				target => "Params"
				remove_field => "Parameters"
			} 
		}
		if [SubscriberId]{
			ruby {
				init => "
					require 'net/http'
					require 'json'
				"
				code => "
					id = event.get('SubscriberId')
					uri = URI.parse('${RAVENDB_URL}/databases/SubscribersPart0/docs/' + id)
					response = Net::HTTP.get_response(uri)
					if response.code == '200'
						result = JSON.parse(response.body)
						event.set('[Subscriber][DateOfBirth]', result['Profile']['DateOfBirth'])
					else
						event.set('Subscriber', 'ERROR reaching database')
					end
				"
			}				
		}
	}
}